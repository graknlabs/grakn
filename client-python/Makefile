
init:
	pip3 install pipenv
	pipenv install --dev


protobuf:
	mkdir -p grakn/service/Keyspace/autogenerated
	mkdir -p grakn/service/Session/autogenerated


	# copy the proto files in to generate in the same directory with correct imports
	cp ../client-protocol/proto/Keyspace.proto grakn/service/Keyspace/autogenerated
	cp ../client-protocol/proto/Answer.proto grakn/service/Session/autogenerated
	cp ../client-protocol/proto/Concept.proto grakn/service/Session/autogenerated
	cp ../client-protocol/proto/Session.proto grakn/service/Session/autogenerated

	# rewrite the imports in the protofiles to match new paths
	# use a sed invocation that is compatible with GNU/BSD sed
	TARGET_PATH="grakn/service/Session/autogenerated"; \
	sed -i.bak -e "s@Concept.proto@$$TARGET_PATH/Concept.proto@g" grakn/service/Session/autogenerated/*.proto; \
	sed -i.bak -e "s@Answer.proto@$$TARGET_PATH/Answer.proto@g" grakn/service/Session/autogenerated/*proto; \
	sed -i.bak -e "s@Session.proto@$$TARGET_PATH/Session.proto@g" grakn/service/Session/autogenerated/*proto; \
	sed -i.bak -e "s@Keyspace.proto@$$TARGET_PATH/Keyspace.proto@g" grakn/service/Session/autogenerated/*proto;
	# rm the extra .bak files created
	find . -name "*.proto.bak" -exec rm {} \;

	# generate protobuf and grpc files for Keyspace
	python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. grakn/service/Keyspace/autogenerated/Keyspace.proto
	# generate protobuf and grpc files for Session
	python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. grakn/service/Session/autogenerated/*.proto

	# delete copied proto files
	rm grakn/service/Keyspace/autogenerated/*.proto
	rm grakn/service/Session/autogenerated/*.proto


