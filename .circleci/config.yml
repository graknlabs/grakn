version: 2.1
commands:
  bazel_install:
    steps:
      - run:
          name: Bazel - Install
          command: |
            curl -OL https://github.com/bazelbuild/bazel/releases/download/0.20.0/bazel-0.20.0-installer-linux-x86_64.sh
            chmod +x bazel-0.20.0-installer-linux-x86_64.sh
            sudo ./bazel-0.20.0-installer-linux-x86_64.sh
  bazel_add_rbe_credential:
    steps:
      - run:
          name: Bazel - Add RBE Credential
          command: |
            if [[ -n "$BAZEL_RBE_CREDENTIAL" ]]; then
              BAZEL_RBE_CREDENTIAL_LOCATION=~/.config/gcloud/application_default_credentials.json
              echo "An RBE credential is found and will be saved to $BAZEL_RBE_CREDENTIAL_LOCATION. Bazel will be executed with RBE support."
              mkdir -p ~/.config/gcloud/
              echo $BAZEL_RBE_CREDENTIAL > "$BAZEL_RBE_CREDENTIAL_LOCATION"
            else
              echo "No RBE credential found. Bazel will be executed locally without RBE support."
            fi
  bazel:
    parameters:
      command:
          type: string
    steps:
      - run:
          name: Bazel - Execute
          command: |
            if [[ -f ~/.config/gcloud/application_default_credentials.json ]]; then
              echo "Bazel will be executed with RBE support. This means the build is remotely executed and the cache will be re-used by subsequent CI jobs."
              CMD="<< parameters.command >> --config=rbe"
            else
              echo "Bazel will be executed locally (without RBE support)."
              CMD="<< parameters.command >>"
            fi
            echo "Executing $CMD"
            $CMD
  rpm_install:
    steps:
      - run:
          name: Install rpm (for rpmbuild)
          command: sudo apt update && sudo apt install rpm -y

jobs:
  build:
    machine: true
    working_directory: ~/grakn
    steps:
      - checkout
      - bazel_install
      - bazel_add_rbe_credential
      - run: bazel run @graknlabs_build_tools//checkstyle:test-coverage
      - rpm_install
      - bazel:
          command: bazel build //...
      - run: mkdir dist/ && mv bazel-genfiles/grakn-core-all.zip dist/
      - persist_to_workspace: # TODO: share Grakn with other jobs by putting it in the workspace
          root: ~/grakn
          paths:
            - .

  test-common:
    machine: true
    working_directory: ~/grakn
    steps:
      - checkout
      - bazel_install
      - bazel_add_rbe_credential
      - bazel:
          command: bazel test //common/... --test_output=errors

  test-console:
    machine: true
    working_directory: ~/grakn
    steps:
      - checkout
      - bazel_install
      - bazel_add_rbe_credential
      - rpm_install
      - bazel:
          command: bazel test //console/... --test_output=errors

  test-server:
    machine: true
    working_directory: ~/grakn
    steps:
      - checkout
      - bazel_install
      - bazel_add_rbe_credential
      - rpm_install
      - bazel:
          command: bazel test //server/... --test_output=errors

  test-integration:
    machine: true
    working_directory: ~/grakn
    steps:
      - checkout
      - bazel_install
      - bazel_add_rbe_credential
      - bazel:
          command: bazel test //test-integration/server/... --test_output=errors
      - bazel:
          command: bazel test //test-integration/graql/executor/... --test_output=errors
      - bazel:
          command: bazel test //test-integration/graql/query/... --test_output=errors

  test-integration-reasoner:
    machine: true
    working_directory: ~/grakn
    steps:
    - checkout
    - bazel_install
    - bazel_add_rbe_credential
    - bazel:
        command: bazel test //test-integration/graql/reasoner/... --test_output=errors

  test-integration-analytics:
    machine: true
    working_directory: ~/grakn
    steps:
    - checkout
    - bazel_install
    - bazel_add_rbe_credential
    - bazel:
        command: bazel test //test-integration/graql/analytics/... --test_output=errors

  test-end-to-end:
    machine: true
    working_directory: ~/grakn
    steps:
      - checkout
      - bazel_install
      - bazel_add_rbe_credential
      - bazel:
          command: bazel build //:distribution
      - bazel:
          command: bazel test //test-end-to-end:test-end-to-end --test_output=streamed --spawn_strategy=standalone

  sync-dependencies:
    machine: true
    steps:
      - checkout
      - bazel_install
      - run:
          name: Sync docs:development workbase:master client-java:master client-python:master client-nodejs:master to the latest Grakn version
          command: |
            bazel run @graknlabs_build_tools//ci:sync-dependencies -- --dependency grakn:master \
              --user docs:development workbase:master client-java:master client-python:master client-nodejs:master
  
  release-approval:
    machine: true
    steps:
      - checkout
      - bazel_install
      - run: bazel run @graknlabs_build_tools//ci:release-approval

  release-github-draft:
    machine: true
    working_directory: ~/grakn
    steps:
      - checkout
      - bazel_install
      - bazel_add_rbe_credential
      - run: bazel run //:deploy-github-zip -- ${GRABL_CREDENTIAL}

  release-cleanup:
    machine: true
    steps:
      - checkout
      - run: git push --delete origin grakn-core-release-branch

workflows:
  # the 'ci' workflow consists of jobs which:
  #  - executes tests (executed on pull requests and master)
  #  - syncs docs/development to the latest grakn version (executed on master only)
  #  - waits for an approval for Grakn to be released (executed on master only)
  grakn-core:
    jobs:
      # test jobs
      - build:
          filters:
            branches:
              ignore: grakn-core-release-branch
      - test-common:
          filters:
            branches:
              ignore: grakn-core-release-branch
      - test-console:
          filters:
            branches:
              ignore: grakn-core-release-branch
      - test-server:
          filters:
            branches:
              ignore: grakn-core-release-branch
      - test-integration:
          filters:
            branches:
              ignore: grakn-core-release-branch
      - test-integration-reasoner:
          filters:
            branches:
              ignore: grakn-core-release-branch
      - test-integration-analytics:
          filters:
            branches:
              ignore: grakn-core-release-branch
      - test-end-to-end:
          filters:
            branches:
              ignore: grakn-core-release-branch

      # sync dependencies to the latest grakn version
      - sync-dependencies:
          filters:
            branches:
              only: master
          requires:
            - build
            - test-common
            - test-console
            - test-server
            - test-integration
            - test-integration-reasoner
            - test-integration-analytics
            - test-end-to-end

      # wait for an approval for Grakn to be released
      # triggers 'ci-release' workflow by creating a branch 'grakn-core-release-branch' in graknlabs/grakn
      - release-approval:
          filters:
            branches:
              only: master
          requires:
            - sync-dependencies

  # the 'grakn-core-release' workflow is triggered by the creation of 'grakn-core-release-branch' branch in graknlabs/grakn
  # it consists of jobs which:
  # - publishes Grakn by creating a Github release
  # - cleans up the 'grakn-core-release-branch' branch which was created by the release-approval job
  grakn-core-release:
    jobs:
      - release-github-draft:
          filters:
            branches:
              only: grakn-core-release-branch
      - release-cleanup:
          requires:
            - release-github-draft
          filters:
            branches:
              only: grakn-core-release-branch
